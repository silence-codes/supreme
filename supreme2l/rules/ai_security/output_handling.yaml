# Supreme 2 Light AI Security Rules - Insecure Output Handling
# Source: OWASP LLM Top 10 2025 (LLM05), Tool Use Attacks Research
# Version: 1.0.0
# Last Updated: 2025-12-29

rules:
  # =============================================================================
  # COMMAND INJECTION FROM LLM OUTPUT
  # =============================================================================

  - id: SUPREME2L-OUTPUT-CMD-001
    name: shell-exec-llm-output
    severity: CRITICAL
    category: command_injection
    patterns:
      - "(?i)(?:subprocess|os\\.system|os\\.popen)\\s*\\(.*(?:llm|ai|gpt|claude|model).*(?:output|response)"
      - "(?i)exec\\s*\\(.*(?:llm|ai|gpt|model).*(?:output|response)"
      - "(?i)shell\\s*=\\s*True.*(?:llm|ai|model)"
    message: "Shell execution of LLM output detected"
    description: |
      Directly executing LLM output in shell commands creates critical
      command injection vulnerabilities. LLM output should never be
      passed to shell commands without strict validation.
    owasp_llm: "LLM05:2025"
    cwe: "CWE-78"
    fix: |
      Never execute LLM output directly. Use allowlists, parameterized
      commands, and strict input validation.

  - id: SUPREME2L-OUTPUT-CMD-002
    name: eval-llm-output
    severity: CRITICAL
    category: command_injection
    patterns:
      - "(?i)eval\\s*\\(.*(?:llm|ai|gpt|claude|model).*(?:output|response)"
      - "(?i)exec\\s*\\(.*(?:llm|ai|gpt|claude|model)"
      - "(?i)compile\\s*\\(.*(?:llm|ai|model).*[\"']exec[\"']"
    message: "Code eval of LLM output detected"
    description: |
      Using eval() or exec() on LLM output allows arbitrary code execution.
    owasp_llm: "LLM05:2025"
    cwe: "CWE-94"

  - id: SUPREME2L-OUTPUT-CMD-003
    name: dangerous-shell-patterns
    severity: CRITICAL
    category: command_injection
    patterns:
      - "(?i)(?:curl|wget).*\\|\\s*(?:bash|sh|python)"
      - "(?i)nc\\s+.*-e\\s+(?:bash|sh)"
      - "(?i)bash\\s+-c\\s+[\"'].*\\$"
    message: "Dangerous shell pattern in output"
    description: |
      Patterns commonly used for remote code execution.
    owasp_llm: "LLM05:2025"
    cwe: "CWE-78"

  # =============================================================================
  # SQL INJECTION FROM LLM OUTPUT
  # =============================================================================

  - id: SUPREME2L-OUTPUT-SQL-001
    name: sql-exec-llm-output
    severity: CRITICAL
    category: sql_injection
    patterns:
      - "(?i)(?:execute|executemany|raw)\\s*\\(.*(?:llm|ai|gpt|model).*(?:output|response|query)"
      - "(?i)cursor\\.execute\\s*\\(\\s*(?:llm|ai|model)"
      - "(?i)f[\"'](?:SELECT|INSERT|UPDATE|DELETE).*\\{.*(?:llm|ai|model)"
    message: "SQL execution of LLM output detected"
    description: |
      Executing SQL queries generated by LLM without parameterization
      creates SQL injection vulnerabilities.
    owasp_llm: "LLM05:2025"
    cwe: "CWE-89"
    fix: |
      Use parameterized queries. Never interpolate LLM output into SQL.

  - id: SUPREME2L-OUTPUT-SQL-002
    name: dangerous-sql-keywords
    severity: HIGH
    category: sql_injection
    patterns:
      - "(?i)DROP\\s+(?:TABLE|DATABASE|SCHEMA)"
      - "(?i)TRUNCATE\\s+TABLE"
      - "(?i)DELETE\\s+FROM\\s+\\w+\\s*(?:;|$|WHERE\\s+1\\s*=\\s*1)"
      - "(?i)UPDATE\\s+\\w+\\s+SET.*WHERE\\s+1\\s*=\\s*1"
    message: "Dangerous SQL keywords in output"
    description: |
      Destructive SQL commands that should never come from LLM output.
    owasp_llm: "LLM05:2025"
    cwe: "CWE-89"

  - id: SUPREME2L-OUTPUT-SQL-003
    name: sql-injection-payloads
    severity: CRITICAL
    category: sql_injection
    patterns:
      - "(?i)(?:--|#|/\\*).*(?:DROP|DELETE|TRUNCATE)"
      - "(?i)UNION\\s+(?:ALL\\s+)?SELECT"
      - "(?i)'\\s*OR\\s+['\"]?\\d+['\"]?\\s*=\\s*['\"]?\\d+"
      - "(?i)xp_cmdshell"
    message: "SQL injection payload detected"
    description: |
      Classic SQL injection patterns in LLM output.
    owasp_llm: "LLM05:2025"
    cwe: "CWE-89"

  # =============================================================================
  # XSS FROM LLM OUTPUT
  # =============================================================================

  - id: SUPREME2L-OUTPUT-XSS-001
    name: unescaped-html-output
    severity: HIGH
    category: xss
    patterns:
      - "(?i)\\|\\s*safe\\b.*(?:llm|ai|model)"
      - "(?i)mark_safe\\s*\\(.*(?:llm|ai|model)"
      - "(?i)innerHTML\\s*=.*(?:llm|ai|model)"
      - "(?i)dangerouslySetInnerHTML.*(?:llm|ai|model)"
    message: "Unescaped LLM output in HTML detected"
    description: |
      Rendering LLM output as raw HTML without escaping enables XSS attacks.
    owasp_llm: "LLM05:2025"
    cwe: "CWE-79"

  - id: SUPREME2L-OUTPUT-XSS-002
    name: script-injection
    severity: CRITICAL
    category: xss
    patterns:
      - "(?i)<script[^>]*>.*</script>"
      - "(?i)javascript\\s*:"
      - "(?i)on(?:load|error|click|mouseover)\\s*="
      - "(?i)<iframe[^>]*src\\s*="
    message: "Script injection pattern in output"
    description: |
      JavaScript execution patterns that could enable XSS.
    owasp_llm: "LLM05:2025"
    cwe: "CWE-79"

  # =============================================================================
  # PATH TRAVERSAL FROM LLM OUTPUT
  # =============================================================================

  - id: SUPREME2L-OUTPUT-PATH-001
    name: path-traversal-output
    severity: HIGH
    category: path_traversal
    patterns:
      - "(?i)open\\s*\\(.*(?:llm|ai|model).*(?:output|response)"
      - "(?i)(?:read|write)_file\\s*\\(.*(?:llm|ai|model)"
      - "(?i)Path\\s*\\(.*(?:llm|ai|model)"
    message: "File operation with LLM output detected"
    description: |
      Using LLM output in file paths without validation enables path traversal.
    owasp_llm: "LLM05:2025"
    cwe: "CWE-22"

  - id: SUPREME2L-OUTPUT-PATH-002
    name: path-traversal-patterns
    severity: HIGH
    category: path_traversal
    patterns:
      - "\\.\\./\\.\\."
      - "(?i)/etc/(?:passwd|shadow)"
      - "(?i)C:\\\\Windows\\\\System32"
      - "(?i)%2e%2e%2f"
    message: "Path traversal pattern in output"
    description: |
      Directory traversal sequences that could access sensitive files.
    owasp_llm: "LLM05:2025"
    cwe: "CWE-22"

  # =============================================================================
  # SSRF FROM LLM OUTPUT
  # =============================================================================

  - id: SUPREME2L-OUTPUT-SSRF-001
    name: ssrf-llm-output
    severity: HIGH
    category: ssrf
    patterns:
      - "(?i)requests\\.(?:get|post|put)\\s*\\(.*(?:llm|ai|model).*(?:output|response)"
      - "(?i)urllib\\.request\\.urlopen\\s*\\(.*(?:llm|ai|model)"
      - "(?i)fetch\\s*\\(.*(?:llm|ai|model)"
    message: "HTTP request with LLM output URL detected"
    description: |
      Using LLM output as URLs without validation enables SSRF attacks.
    owasp_llm: "LLM05:2025"
    cwe: "CWE-918"

  - id: SUPREME2L-OUTPUT-SSRF-002
    name: internal-url-patterns
    severity: HIGH
    category: ssrf
    patterns:
      - "(?i)(?:localhost|127\\.0\\.0\\.1|0\\.0\\.0\\.0)"
      - "(?i)(?:169\\.254\\.169\\.254)"
      - "(?i)(?:192\\.168\\.|10\\.|172\\.(?:1[6-9]|2[0-9]|3[01])\\.)"
      - "(?i)file://"
    message: "Internal/local URL pattern in output"
    description: |
      URLs pointing to internal services or metadata endpoints.
    owasp_llm: "LLM05:2025"
    cwe: "CWE-918"

  # =============================================================================
  # DESERIALIZATION FROM LLM OUTPUT
  # =============================================================================

  - id: SUPREME2L-OUTPUT-DESER-001
    name: unsafe-deserialization
    severity: CRITICAL
    category: deserialization
    patterns:
      - "(?i)pickle\\.loads?\\s*\\(.*(?:llm|ai|model)"
      - "(?i)yaml\\.(?:load|unsafe_load)\\s*\\(.*(?:llm|ai|model)"
      - "(?i)eval\\s*\\(.*(?:llm|ai|model)"
    message: "Unsafe deserialization of LLM output detected"
    description: |
      Deserializing LLM output with unsafe methods enables code execution.
    owasp_llm: "LLM05:2025"
    cwe: "CWE-502"

  # =============================================================================
  # EMAIL/COMMUNICATION FROM LLM OUTPUT
  # =============================================================================

  - id: SUPREME2L-OUTPUT-EMAIL-001
    name: email-from-llm
    severity: MEDIUM
    category: communication
    patterns:
      - "(?i)send_mail\\s*\\(.*(?:llm|ai|model)"
      - "(?i)smtp.*send.*(?:llm|ai|model)"
      - "(?i)MIMEText\\s*\\(.*(?:llm|ai|model)"
    message: "Email sent with LLM content detected"
    description: |
      Sending emails with LLM-generated content without review could
      enable phishing or spam.
    owasp_llm: "LLM05:2025"
    cwe: "CWE-284"

  # =============================================================================
  # LDAP/DIRECTORY INJECTION
  # =============================================================================

  - id: SUPREME2L-OUTPUT-LDAP-001
    name: ldap-injection
    severity: HIGH
    category: ldap_injection
    patterns:
      - "(?i)ldap.*search.*(?:llm|ai|model)"
      - "(?i)\\(\\|\\(.*=\\*\\)"
      - "(?i)\\)\\(\\|\\("
    message: "LDAP injection pattern detected"
    description: |
      LDAP injection patterns that could enable directory enumeration.
    owasp_llm: "LLM05:2025"
    cwe: "CWE-90"

  # =============================================================================
  # TEMPLATE INJECTION
  # =============================================================================

  - id: SUPREME2L-OUTPUT-TEMPLATE-001
    name: template-injection
    severity: HIGH
    category: template_injection
    patterns:
      - "(?i)\\{\\{.*(?:config|self|request)"
      - "(?i)\\{%.*(?:import|include|extends)"
      - "(?i)\\$\\{.*(?:Runtime|ProcessBuilder)"
    message: "Template injection pattern detected"
    description: |
      Server-side template injection patterns.
    owasp_llm: "LLM05:2025"
    cwe: "CWE-94"

  # =============================================================================
  # MISSING OUTPUT VALIDATION
  # =============================================================================

  - id: SUPREME2L-OUTPUT-VALID-001
    name: no-output-validation
    severity: MEDIUM
    category: missing_validation
    patterns:
      - "(?i)(?:llm|ai|model).*(?:output|response).*(?:directly|without)"
      - "(?i)trust.*(?:llm|ai|model).*output"
      - "(?i)skip.*(?:validation|sanitization).*(?:llm|ai)"
    message: "Missing output validation pattern detected"
    description: |
      LLM output used without validation or sanitization.
    owasp_llm: "LLM05:2025"
    cwe: "CWE-20"

  - id: SUPREME2L-OUTPUT-VALID-002
    name: privileged-action-from-llm
    severity: HIGH
    category: missing_validation
    patterns:
      - "(?i)(?:admin|sudo|root).*(?:llm|ai|model).*(?:output|response)"
      - "(?i)(?:llm|ai|model).*(?:output|response).*(?:admin|privileged)"
      - "(?i)elevate.*(?:llm|ai|model)"
    message: "Privileged action from LLM output detected"
    description: |
      LLM output triggering privileged operations without validation.
    owasp_llm: "LLM05:2025"
    cwe: "CWE-269"
